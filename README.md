<div align="center">

# üêç MLIR Python ‚ûï Nix ‚ùÑÔ∏è

**A batteries-included, bleeding-edge template for MLIR Python development.**

[![built with nix](https://img.shields.io/badge/Built_with_Nix-7EBAE4?style=flat&logo=nixos&logoColor=white&labelColor=5277C3)](https://builtwithnix.org)
[![Built with Devenv](https://img.shields.io/badge/Built%20with-Devenv-_330882.svg?logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBmaWxsPSIjNDM5OEZGIiBkPSJNMjkuMjUgMTYuMDQzYzAtNy4zMi01LjkzMy0xMy4yNTMtMTMuMjUtMTMuMjUzcy0xMy4yNTMgNS45MzMtMTMuMjUzIDEzLjI1M2MwIDYuNzMgNS4wMDQgMTIuMzEgMTEuNTI4IDEzLjE0MlYxNi4wNTNjLS4wMS0xLjQ5My43Mi0yLjg5MyAyLjAyLTMuMzkzdi0uMDAyYzEuMTctLjQ0IDIuNTQtLjE0IDMuNDcgLjY4di4wMDJjLjc2Ljc0IDEuMDMgMS44Ni42NiAyLjg3bC0uMDAxLjAwM2MtLjI4Ljc1LS45MyAxLjI4LTEuNzUgMS40M2wtLjA1LjAwOWMuNDg3LjMyIDEuMDM4LjQyIDEuNTkuMjcuNDI3LS4xMTMuODA1LS4zOSAxLjA5LS43N2wuMDAyLS4wMDNjLjcyLTEgLjQ1LTIuMzktLjczLTMuMTNsLS4wMDItLjAwYy0uODgtLjU0LTIuMDEtLjYyLTMuMDItLjI0bC0uMDIuMDA2Yy0uMzUuMTMtLjY2LjMyLS45MS41N2EyLjk0IDIuOTQgMCAwIDAtLjkzIDIuMDVjLS4wMDQuMS0uMDA3LjItLjAwOS4zdi4wMDJjLS4wMDMuMTA1LS4wMDMuMjEtLjAwMy4zMTZ2OC4yOGM2LjIzMy0xLjEgMTAuNzYtNi40MyAxMC43Ni0xMi42NFoiPjwvcGF0aD48L3N2Zz4=)](https://devenv.sh/)
[![Python Version](https://img.shields.io/badge/Python-3.12+-blue.svg?logo=python)](https://www.python.org/)
[![pre-commit](https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit)](https://pre-commit.com/)

</div>

> [!WARNING]
> This `README.md` is generated by Gemini 2.5 Pro Preview 06-05.

---

This template uses the power of [Nix](https://nixos.org/) and [Devenv](https://devenv.sh/) to build [MLIR](https://mlir.llvm.org/) from source and seamlessly inject its Python bindings into a modern, fast development environment.

## üåü Features

-   üßä **Fully Reproducible Environment**: Powered by [Nix Flakes](https://nixos.wiki/wiki/Flakes), the exact versions of all system-level dependencies (like LLVM, compilers, and libraries) are pinned for absolute consistency.

-   ‚öôÔ∏è **Custom MLIR Build**: The Nix Flake automatically compiles a specific version of LLVM/MLIR with Python bindings enabled. No manual `cmake` or `make` required!

-   üêç **Seamless Python Integration**: The compiled `mlir` Python bindings are automatically available in your virtual environment. Just `import mlir` and go!

-   ‚ö°Ô∏è **Blazing-fast Python Tooling**: Uses [`uv`](https://github.com/astral-sh/uv) for rapid dependency management and venv creation, all managed via `pyproject.toml`.

-   ‚úÖ **Automated Code Quality**: Comes with pre-configured [pre-commit](https://pre-commit.com/) hooks via `devenv` for formatters (`black`, `nixfmt-rfc-style`) and linters (`mypy`, `flake8`).

-   üê≥ **Dev Container Ready**: Get a one-click, fully configured development environment in VS Code, powered by `devenv`.

-   üåê **Cross-Platform (Work in Progress)**: The environment is defined for multiple systems (`x86_64-linux`, `aarch64-darwin`, etc.), but has not yet been fully tested across all architectures. Cross-compilation is not yet configured.

## üöÄ Getting Started

### Prerequisites

You need [Nix installed with Flakes enabled](https://nixos.org/download.html). If you haven't enabled flakes yet, add this to your Nix config (`/etc/nix/nix.conf` or `~/.config/nix/nix.conf`):

```
experimental-features = nix-command flakes
```

### 1. Clone the Repository

```sh
git clone <your-repo-url>
cd <your-repo-name>
```

### 2. Enter the Magic Shell

```sh
direnv allow
```

or if you want to enter the devenv manually:

```sh
nix develop ./nix
```

> [!WARNING]
> The first time you run this, Nix will download and build all dependencies, specifically building a MLIR compiler with Python3 binding support.
> **This will take a while!** ‚òï Subsequent runs will be instantaneous thanks to the Nix cache.

This command activates your new shell, where all tools, libraries, and Python packages are ready to use.

## ‚úÖ Verification & Usage

Once inside the devenv shell:

#### 1. Run the Example Script

The `hello-mlir/hello_mlir.py` script confirms that the bindings work.

```sh
python -m hello-mlir.hello_mlir
```

#### 2. Check the Linters and Hooks

The environment comes with pre-commit hooks configured in `.pre-commit-config.yaml` and managed by `devenv`. They will run automatically when you `git commit`. You can also run them manually:

```sh
# Run mypy to check types (it should find the mlir stubs!)
mypy hello-mlir/hello_mlir.py
# Success: no issues found in 1 source file

# Run all hooks on all files
pre-commit run --all-files
```

## üê≥ VS Code & Dev Containers

For the ultimate one-click setup, this project is configured for [VS Code Dev Containers](https://code.visualstudio.com/docs/devcontainers/containers).

### How to Use

1.  **Prerequisites**:
    -   [Docker Desktop](https://www.docker.com/products/docker-desktop/) or another container runtime.
    -   [Visual Studio Code](https://code.visualstudio.com/).
    -   The [Dev Containers extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) for VS Code.

2.  **Launch**:
    -   Open the project folder in VS Code.
    -   A notification will appear in the bottom-right corner: "Reopen in Container". Click it.
    -   Alternatively, open the command palette (`Ctrl/Cmd + Shift + P`) and select `Dev Containers: Reopen in Container`.

VS Code will now build the container and start a terminal with the devenv already active. The recommended `mkhl.direnv` extension will be installed automatically for a seamless experience.



## üõ†Ô∏è How It Works


1.  **The Brain (`nix/flake.nix`)**: This is the central control hub. It uses Nix Flakes to define all dependencies, including a custom-built MLIR.

2.  **The Custom Build**: We take the standard `mlir` package from `nixpkgs` and override its build process to:
    -   Enable Python bindings with `-DMLIR_ENABLE_BINDINGS_PYTHON=ON`.
    -   Link it against the correct Python interpreter.
    -   Ensure `pybind11` is available during the build.

3.  **The Magic Shell (`devenv.shells.default`)**: [Devenv](https://devenv.sh/) wraps everything into a perfect development shell. It installs our custom MLIR package and sets up the Python environment.

4.  **The Python Bridge (`nix/python.nix`)**:
    -   Devenv and `uv` work together to create a local virtual environment (`.devenv/state/venv`).
    -   The `PYTHONPATH` is surgically modified to include the path to the Nix-built `mlir` python packages.
    -   `LD_LIBRARY_PATH` is set so the Python bindings can find their C++ shared library dependencies at runtime.
